<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title> Centralized Digital Lead Management </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* (styles unchanged from original file) */
        :root {
            --bg-body: #050816;
            --bg-header: #050816;
            --bg-sidebar: #0b1020;
            --bg-card: #0f172a;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --text-soft: #6b7280;
            --accent: #6366f1;
            --accent-soft: rgba(99, 102, 241, 0.15);
            --accent-strong: #4f46e5;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        /* ... rest of CSS omitted here for brevity but should be identical to your original file ... */
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="login-header">
                <div class="login-title">Centralized Digital Lead Management</div>
            </div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password" required>
                </div>
                <button type="submit" class="login-btn">Sign In</button>
            </form>
            <div class="login-footer">
                Use your assigned Rotomag CDLM credentials.
            </div>
        </div>
    </div>

    <!-- APP SHELL -->
    <div class="app-shell hidden" id="appShell">
        <header class="header">
            <div class="brand">
                <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
                <div class="brand-logo">üìä</div>
                <div>
                    <div class="brand-text">Centralized Digital Lead Management</div>
                    <div class="brand-sub">CDLM</div>
               </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-name" id="headerUsername">User</div>
                    <div class="user-role" id="headerUserRole">Team Member</div>
                </div>
                <button class="header-btn" id="settingsBtn" onclick="openSettingsModal()" style="display:none;">‚öôÔ∏è Settings</button>
                <button class="header-btn" onclick="handleLogout()">üö™ Logout</button>
            </div>
        </header>

        <main class="app-main">
            <!-- SIDEBAR -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">Dashboard</div>
                    <div class="nav-item active"><span>üìä</span><span>Overview</span></div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Import Data</div>
                    <div class="file-input-wrapper">
                        <input type="file" id="csvFile" accept=".csv,.xlsx" onchange="handleFileSelect(event)">
                        <label for="csvFile" class="file-input-label">üìÅ Select File (CSV/Sheet)</label>
                    </div>
                    <button id="processBtn" class="btn btn-primary" onclick="processCSV()" disabled>‚ö° Process</button>
                    <button class="btn btn-secondary" onclick="clearImport()">üîÑ Reset</button>
                </div>

                <div class="divider"></div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Lead Database</div>
                    <div class="sidebar-stats">üìä Total: <strong id="sidebarTotalLeads">0</strong></div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Team Assignment</div>
                    <div id="assignedPeopleContainer"></div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Activity</div>
                    <div class="debug-log" id="debugLog">
                        <div class="log-entry info">[--:--:--] Loading‚Ä¶</div>
                    </div>
                </div>
            </aside>

            <!-- MAIN PAGE -->
            <section class="page">
                <div class="page-header">
                    <h1 class="page-title">CDLM</h1>
                    <p class="page-subtitle">Upload CSV / Google Sheet ‚Üí Auto Clean &amp; Segment ‚Üí Manage &amp; Track</p>
                </div>

                <div id="messageContainer"></div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-number" id="kpiTotal">0</div>
                        <div class="kpi-label">Total Leads</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-number" id="kpiAssigned">0</div>
                        <div class="kpi-label">Assigned</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-number" id="kpiQualified">0</div>
                        <div class="kpi-label">Qualified / Converted</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-number" id="kpiCampaign">0</div>
                        <div class="kpi-label">Campaign Enabled</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">üìä All Leads</div>
                            <div class="card-subtitle">Centralized view ‚Ä¢ Filter ‚Ä¢ Edit ‚Ä¢ Delete</div>
                        </div>
                    </div>

                    <div class="filters-container">
                        <div class="filters-title">üîç Filters</div>
                        <div class="filters-row">
                            <div class="filter-group">
                                <label>Name</label>
                                <input type="text" id="searchName" placeholder="Search‚Ä¶" onkeyup="applyFilters()">
                            </div>
                            <div class="filter-group">
                                <label>Category</label>
                                <select id="filterCategory" onchange="applyFilters()">
                                    <option value="">All</option>
                                    <option value="Request Call Back">Request Call Back</option>
                                    <option value="Meet Senior Person">Meet Senior Person</option>
                                    <option value="Interested in Quote">Interested in Quote</option>
                                    <option value="Send Product Details">Send Product Details</option>
                                    <option value="Requesting Demo">Requesting Demo</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Segment</label>
                                <select id="filterSegment" onchange="applyFilters()">
                                    <option value="">All</option>
                                    <option value="Pune">Pune</option>
                                    <option value="Ahmedabad">Ahmedabad</option>
                                    <option value="Bangalore">Bangalore</option>
                                    <option value="Maharashtra">Maharashtra</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Assign To</label>
                                <select id="filterAssignTo" onchange="applyFilters()">
                                    <option value="">All</option>
                                    <option value="Onkar">Onkar</option>
                                    <option value="Goraksha">Goraksha</option>
                                    <option value="Sachin">Sachin</option>
                                    <option value="Rajesh">Rajesh</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="filterStatus" onchange="applyFilters()">
                                    <option value="">All</option>
                                    <option value="Lead Collected">Lead Collected</option>
                                    <option value="Assigned">Assigned</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Converted">Converted</option>
                                </select>
                            </div>
                            <div style="display:flex;gap:6px;align-items:flex-end;">
                                <button class="btn btn-primary" style="margin:0;padding:8px;" onclick="applyFilters()">Filter</button>
                                <button class="btn btn-secondary" style="margin:0;padding:8px;" onclick="clearFilters()">Reset</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table id="leadsTable">
                            <thead>
                                <tr>
                                    <th>Lead ID</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Product</th>
                                    <th>City</th>
                                    <th>Who you are?</th>
                                    <th>Reference</th>
                                    <th>Category</th>
                                    <th>Segment</th>
                                    <th>Assign To</th>
                                    <th>Status</th>
                                    <th>Campaign</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr>
                                    <td colspan="14">
                                        <div class="empty-state">üìÅ No leads yet.</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Settings</div>
                <button class="modal-close" onclick="closeSettingsModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="settings-section-title">Current User</div>
                    <div class="settings-item">
                        <div class="settings-item-title" id="settingsCurrentUser">User</div>
                        <div class="settings-item-subtitle" id="settingsCurrentRole">Role</div>
                        <span class="role-badge admin">Admin</span>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">Manage Users</div>
                    <div id="usersListContainer"></div>
                    <button class="btn btn-primary" onclick="showAddUserForm()" style="width:100%;margin-top:12px;">+ Add New User</button>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">About</div>
                    <div class="settings-item">
                        <div class="settings-item-title">CDLM v4.2 AUTOMATIC CLEANSING PROCESS </div>
                        <div style="margin-top:8px;font-size:10px;color:var(--text-soft);">
                            üìß Support: queensi@rotomag.com
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeSettingsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (only used if you enable USE_FIREBASE) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // ---------- CONFIG ----------
        // By default Firebase is disabled. To enable:
        // 1) Create a Firebase project -> Firestore (in test mode or configure rules).
        // 2) Set USE_FIREBASE = true
        // 3) Paste your firebaseConfig below.
        const USE_FIREBASE = false; // <--- set true after you paste firebaseConfig
        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            // rest of config fields (storageBucket, messagingSenderId, appId) as provided by Firebase
        };
        // ---------------------------

        const USERS = {
            'admin':   { password: 'admin123',   displayName: 'Admin',   isAdmin: true  },
            'onkar':   { password: 'onkar123',   displayName: 'Onkar',   isAdmin: false },
            'goraksha':{ password: 'goraksha123',displayName: 'Goraksha',isAdmin: false },
            'sachin':  { password: 'sachin123',  displayName: 'Sachin',  isAdmin: false },
            'rajesh':  { password: 'rajesh123',  displayName: 'Rajesh',  isAdmin: false }
        };

        const TEAM_MEMBERS = ['Onkar', 'Goraksha', 'Sachin', 'Rajesh'];
        const CATEGORY_OPTIONS = ['Request Call Back', 'Meet Senior Person', 'Interested in Quote', 'Send Product Details', 'Requesting Demo'];

        let currentUser = null;
        const STORAGE_KEY = 'cdlm_leads_store_v9';
        let allLeads = [];
        let registeredPhones = new Set();
        let registeredEmails = new Set();

        // Firebase DB handle (if enabled)
        let db = null;

        // ---------- Login / UI ----------
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('loginUsername').value.trim();
            const p = document.getElementById('loginPassword').value.trim();

            if (USERS[u] && USERS[u].password === p) {
                currentUser = { username: u, displayName: USERS[u].displayName, isAdmin: USERS[u].isAdmin };
                localStorage.setItem('cdlm_current_user', JSON.stringify(currentUser));
                showDashboard();
            } else {
                alert('Invalid username or password.');
            }
        }

        function handleLogout() {
            if (!confirm('Logout from CDLM?')) return;
            currentUser = null;
            localStorage.removeItem('cdlm_current_user');
            document.getElementById('appShell').classList.add('hidden');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appShell').classList.remove('hidden');
            document.getElementById('headerUsername').textContent = currentUser.displayName;
            document.getElementById('headerUserRole').textContent = currentUser.isAdmin ? 'Administrator' : 'Team Member';
            document.getElementById('settingsCurrentUser').textContent = currentUser.displayName;
            document.getElementById('settingsCurrentRole').textContent = currentUser.isAdmin ? 'Administrator' : 'Team Member';
            const settingsBtn = document.getElementById('settingsBtn');
            settingsBtn.style.display = currentUser.isAdmin ? 'inline-flex' : 'none';

            // Init data source (Firebase or localStorage)
            initDataSource();
        }

        // ---------- Firebase initialization and realtime listener ----------
        function initDataSource() {
            if (USE_FIREBASE && firebaseConfig && firebaseConfig.projectId) {
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    addDebugLog('‚úÖ Firebase initialized', 'success');

                    // Realtime listener: when 'leads' collection changes, update local state and UI
                    db.collection('leads').orderBy('date_added', 'asc').onSnapshot(snapshot => {
                        allLeads = snapshot.docs.map(d => ({ ...d.data(), _id: d.id }));
                        buildPhoneRegistry();
                        renderForCurrentUser();
                        addDebugLog('üîÅ Realtime: leads updated (' + allLeads.length + ')', 'info');
                    }, err => {
                        addDebugLog('Realtime error: ' + err.message, 'error');
                    });
                } catch (err) {
                    addDebugLog('Firebase init failed: ' + err.message, 'error');
                    // fallback to local
                    loadDataFromLocal();
                    renderForCurrentUser();
                }
            } else {
                loadDataFromLocal();
                renderForCurrentUser();
            }
        }

        // ---------- Local storage fallback ----------
        function loadDataFromLocal() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                allLeads = stored ? JSON.parse(stored) : [];
                addDebugLog('Loaded ' + allLeads.length + ' leads (local)', 'success');
            } catch (e) {
                allLeads = [];
                addDebugLog('Local load error', 'error');
            }
            buildPhoneRegistry();
        }

        function saveDataToLocal() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allLeads));
                addDebugLog('Saved leads to localStorage', 'info');
            } catch (e) {
                addDebugLog('Local save error', 'error');
            }
        }

        // ---------- Registry ----------
        function buildPhoneRegistry() {
            registeredPhones.clear();
            registeredEmails.clear();
            allLeads.forEach(l => {
                if (l.phone_number) registeredPhones.add(l.phone_number);
                if (l.email && l.email !== '') registeredEmails.add(l.email);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('cdlm_current_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
            }
        });

        function addDebugLog(msg, type = 'info') {
            const box = document.getElementById('debugLog');
            const div = document.createElement('div');
            div.className = 'log-entry ' + type;
            const t = new Date().toLocaleTimeString();
            div.textContent = '[' + t + '] ' + msg;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // ---------- File import ----------
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                addDebugLog('File: ' + file.name, 'info');
                document.getElementById('processBtn').disabled = false;
            }
        }

        function clearImport() {
            document.getElementById('csvFile').value = '';
            document.getElementById('processBtn').disabled = true;
        }

        async function processCSV() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) {
                showMessage('Select a file (CSV or Google Sheet export).', 'error');
                return;
            }

            try {
                addDebugLog('Processing‚Ä¶', 'info');
                document.getElementById('processBtn').disabled = true;
                const text = await file.text();
                const rows = parseCSV(text);
                addDebugLog('Rows parsed: ' + rows.length, 'info');
                const cleaned = cleanData(rows);
                addDebugLog('Cleaned: ' + cleaned.length, 'success');
                const result = filterDuplicates(cleaned);
                if (result.blocked > 0) {
                    addDebugLog('üö´ Blocked duplicates: ' + result.blocked, 'warning');
                }
                await addLeadsToDatabase(result.new);
                // If using local storage we already updated UI in function; if using Firebase, realtime listener will handle UI,
                // but render immediate feedback too:
                renderForCurrentUser();
                const msg = result.blocked > 0
                    ? 'Added ' + result.new.length + '. Blocked ' + result.blocked + ' duplicates.'
                    : 'Added ' + result.new.length + '.';
                showMessage(msg, 'success');
            } catch (err) {
                showMessage('Error: ' + (err.message || err), 'error');
                addDebugLog('Error: ' + (err.message || err), 'error');
            } finally {
                document.getElementById('csvFile').value = '';
                document.getElementById('processBtn').disabled = false;
            }
        }

        // ---------- CSV parsing / cleaning (unchanged logic) ----------
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) return [];
            const headers = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase());
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const cells = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((h, idx) => { 
                    row[h] = cells[idx] ? cells[idx].trim() : ''; 
                });
                if (Object.values(row).some(v => v !== '')) rows.push(row);
            }
            return rows;
        }

        function parseCSVLine(line) {
            const cells = [];
            let current = '';
            let insideQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                if (char === '"' && nextChar === '"') {
                    current += '"';
                    i++;
                } else if (char === '"') {
                    insideQuotes = !insideQuotes;
                } else if (char === ',' && !insideQuotes) {
                    cells.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            cells.push(current);
            return cells;
        }

        function levenshtein(a, b) {
            const m = a.length, n = b.length;
            const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
            for (let i = 0; i <= m; i++) dp[i][0] = i;
            for (let j = 0; j <= n; j++) dp[0][j] = j;
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    dp[i][j] = Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1, dp[i - 1][j - 1] + cost);
                }
            }
            return dp[m][n];
        }

        const COMMON_EMAIL_DOMAINS = ['gmail.com','yahoo.com','outlook.com','hotmail.com','live.com','aol.com','icloud.com','proton.me','protonmail.com','rediffmail.com','rotomag.com','rotosol.com'];
        const DOMAIN_FIX_MAP = {'mail.com':'gmail.com','gmal.com':'gmail.com','gmial.com':'gmail.com','gmail.co':'gmail.com','gmail.con':'gmail.com','gnail.com':'gmail.com','yahooo.com':'yahoo.com'};
        function bestCommonDomain(d) {
            let best = { domain: d, distance: Infinity };
            for (const known of COMMON_EMAIL_DOMAINS) {
                const dist = levenshtein(d, known);
                if (dist < best.distance) best = { domain: known, distance: dist };
            }
            return best;
        }
        function fixEmailDomain(domainRaw) {
            let d = (domainRaw || '').trim().toLowerCase();
            d = d.replace(/[,;]+$/g, '');
            if (DOMAIN_FIX_MAP[d]) return { domain: DOMAIN_FIX_MAP[d], corrected: true };
            if (!/\.[a-z]{2,}$/.test(d)) {
                const candidate = `${d}.com`;
                const best = bestCommonDomain(candidate);
                if (best.distance <= 2) return { domain: best.domain, corrected: true };
                return { domain: candidate, corrected: true };
            }
            const best = bestCommonDomain(d);
            if (best.distance <= 2) return { domain: best.domain, corrected: true };
            return { domain: d, corrected: false };
        }
        function normalizeEmail(raw) {
            if (!raw) return { email: '', corrected: false };
            let e = String(raw).trim();
            e = e.replace(/\s+/g, '').toLowerCase();
            e = e.replace(/\(at\)/g, '@').replace(/\[at\]/g, '@');
            if (!e.includes('@')) return { email: '', corrected: false };
            const parts = e.split('@');
            if (parts.length !== 2) return { email: '', corrected: false };
            const [local, domainRaw] = parts;
            if (!local) return { email: '', corrected: false };
            const { domain, corrected } = fixEmailDomain(domainRaw);
            return { email: `${local}@${domain}`, corrected };
        }

        function cleanProduct(value) {
            if (!value || value === '' || value === null || value === undefined) return '';
            const trimmed = String(value).trim();
            if (!trimmed) return '';
            if (trimmed.includes(';')) {
                const parts = trimmed.split(';').map(p => p.trim()).filter(p => p !== '');
                if (parts.length > 0) {
                    addDebugLog(`üîÑ Product formatted: "${trimmed}" ‚Üí "${parts.join(', ')}"`, 'success');
                    return parts.join(', ');
                }
            }
            return trimmed;
        }

        function cleanReference(value) {
            if (!value || value === '' || value === null || value === undefined) return '-';
            const trimmed = String(value).trim().toUpperCase();
            const naPatterns = ['#NA', 'NA', 'N/A', '#N/A', 'NIL', 'NONE', 'BLANK', 'NULL', '-', '--', 'EMPTY'];
            if (naPatterns.includes(trimmed)) {
                addDebugLog(`‚úÖ Reference cleaned: "${value}" ‚Üí "-"`, 'success');
                return '-';
            }
            return String(value).trim();
        }

        function getValue(row, keys) {
            for (const k of keys) {
                if (row[k] && row[k].trim() !== '') {
                    return row[k];
                }
            }
            return '';
        }

        function cleanPhoneNumber(phone) {
            if (!phone) return null;
            if (phone.includes('E') || phone.includes('e')) {
                try { phone = parseFloat(phone).toString(); } catch { return null; }
            }
            const digits = phone.replace(/\D/g, '');
            if (digits.length < 10) return null;
            const last10 = digits.slice(-10);
            return '+91-' + last10.slice(0, 5) + '-' + last10.slice(5);
        }

        function cleanData(rows) {
            const cleaned = [];
            let skipped = 0;

            rows.forEach(row => {
                const name = getValue(row, ['full name','full_name','name','exhibitor name','company name','organisation name']);
                let phone = getValue(row, ['contact number','contact_number','phone','mobile','phone number','contact','telephone']);
                const city = getValue(row, ['city / state','city/state','city','location','state','city/country']);

                const productRaw = getValue(row, ['interested in','interested_in','what product','product interested']);
                const product = cleanProduct(productRaw);

                const categoryRaw = getValue(row, ['category','product','type','industry','segment','interested in','what are you interested in']);

                const referenceRaw = getValue(row, ['if any referance','if any reference','reference in']);
                const reference = cleanReference(referenceRaw);

                const whoYouAre = getValue(row, ['who you are?','who you are','identify','who_you_are']);
                const emailRaw = getValue(row, ['email','e-mail','mail','email id','email_id','work email','business email']);

                if (!name || !phone) { skipped++; return; }
                phone = cleanPhoneNumber(phone);
                if (!phone) { skipped++; return; }

                let emailInfo = { email: '', corrected: false };
                if (emailRaw && emailRaw.trim() !== '') {
                    emailInfo = normalizeEmail(emailRaw);
                    if (emailInfo.email && emailInfo.corrected) {
                        addDebugLog(`‚úâÔ∏è Email domain auto-corrected ‚Üí ${emailInfo.email}`, 'success');
                    }
                }

                cleaned.push({
                    full_name: name.trim(),
                    phone_number: phone,
                    email: emailInfo.email || '',
                    product: product || '',
                    city: city ? city.trim() : '',
                    who_you_are: whoYouAre.trim(),
                    category: categoryRaw.trim() || '',
                    reference: reference || '-',
                    source: emailInfo.corrected ? 'Upload (email domain corrected)' : 'Upload'
                });
            });

            if (skipped > 0) addDebugLog('Skipped: ' + skipped + ' (invalid data)', 'warning');
            return cleaned;
        }

        function filterDuplicates(leads) {
            const fresh = [];
            let blocked = 0;
            leads.forEach(l => {
                const byPhone = registeredPhones.has(l.phone_number);
                const emailOk = l.email && l.email !== '';
                const byEmail = emailOk && registeredEmails.has(l.email);

                if (byPhone || byEmail) {
                    blocked++;
                    if (byPhone) addDebugLog(`üö´ Blocked: Phone exists - ${l.phone_number}`, 'warning');
                    if (byEmail) addDebugLog(`üö´ Blocked: Email exists - ${l.email}`, 'warning');
                } else {
                    fresh.push(l);
                    registeredPhones.add(l.phone_number);
                    if (emailOk) registeredEmails.add(l.email);
                }
            });
            return { new: fresh, blocked };
        }

        // Assignment and segment determination (unchanged)
        function determineAssignment(city, segment) {
            if (!city) city = '';
            if (!segment) segment = '';
            const c = city.toLowerCase();
            const s = segment.toLowerCase();

            if (c.includes('pune') || c.includes('dharashiv')) {
                if (s.includes('hot'))  return 'Onkar';
                if (s.includes('warm') || s.includes('cold')) return 'Goraksha';
                return 'Onkar';
            }

            if (c.includes('ahmedabad') || c.includes('jalgaon') || c.includes('dhulia')) {
                if (s.includes('hot'))  return 'Sachin';
                if (s.includes('warm') || s.includes('cold')) return 'Rajesh';
                return 'Sachin';
            }

            return '';
        }

        // determineSegment placeholder (if you already had a function in original file use that)
        function determineSegment(city) {
            if (!city) return '';
            const c = city.toLowerCase();
            if (c.includes('pune')) return 'Pune';
            if (c.includes('ahmedabad')) return 'Ahmedabad';
            if (c.includes('bangalore') || c.includes('bengaluru')) return 'Bangalore';
            if (c.includes('maharashtra')) return 'Maharashtra';
            return '';
        }

        // ---------- Add leads to DB (local or Firebase) ----------
        async function addLeadsToDatabase(newLeads) {
            if (!newLeads || newLeads.length === 0) return;

            if (USE_FIREBASE && db) {
                try {
                    const batch = db.batch();
                    newLeads.forEach(l => {
                        // generate a reasonably unique lead_id (Firestore doc id will also exist)
                        const leadId = 'L' + (Date.now().toString().slice(-8)) + Math.floor(Math.random() * 90 + 10);
                        const seg = l.segment && l.segment !== '' ? l.segment : determineSegment(l.city);
                        const autoAssignTo = l.assign_to && l.assign_to !== '' ? l.assign_to : determineAssignment(l.city, seg);
                        const docRef = db.collection('leads').doc(); // auto id
                        batch.set(docRef, {
                            lead_id: leadId,
                            full_name: l.full_name || '',
                            phone_number: l.phone_number || '',
                            email: l.email || '',
                            product: l.product || '',
                            city: l.city || '',
                            who_you_are: l.who_you_are || '',
                            category: l.category || '',
                            reference: l.reference || '-',
                            source: l.source || 'Upload',
                            segment: seg,
                            assign_to: autoAssignTo,
                            status: l.status || (autoAssignTo ? 'Assigned' : 'Lead Collected'),
                            campaign_enabled: l.campaign_enabled || 'No',
                            date_added: l.date_added || new Date().toISOString().split('T')[0]
                        });
                    });
                    await batch.commit();
                    addDebugLog('‚úÖ Saved ' + newLeads.length + ' leads to Firestore', 'success');
                    // realtime listener will update allLeads and UI
                } catch (err) {
                    addDebugLog('Firestore write error: ' + err.message, 'error');
                    // fallback: push to local
                    mapAndSaveLocally(newLeads);
                }
            } else {
                // local fallback (existing behavior)
                mapAndSaveLocally(newLeads);
            }
        }

        function mapAndSaveLocally(newLeads) {
            const mapped = newLeads.map((l, index) => {
                const leadId = 'L' + (allLeads.length + index + 1).toString().padStart(4, '0');
                const seg = l.segment && l.segment !== '' ? l.segment : determineSegment(l.city);
                const autoAssignTo = l.assign_to && l.assign_to !== ''
                    ? l.assign_to
                    : determineAssignment(l.city, seg);

                return {
                    lead_id: leadId,
                    full_name: l.full_name || '',
                    phone_number: l.phone_number || '',
                    email: l.email || '',
                    product: l.product || '',
                    city: l.city || '',
                    who_you_are: l.who_you_are || '',
                    category: l.category || '',
                    reference: l.reference || '-',
                    source: l.source || 'Upload',
                    segment: seg,
                    assign_to: autoAssignTo,
                    status: l.status || (autoAssignTo ? 'Assigned' : 'Lead Collected'),
                    campaign_enabled: l.campaign_enabled || 'No',
                    date_added: l.date_added || new Date().toISOString().split('T')[0]
                };
            });
            allLeads = allLeads.concat(mapped);
            saveDataToLocal();
            buildPhoneRegistry();
            addDebugLog('‚úÖ Added ' + mapped.length + ' leads (local)', 'success');
        }

        // ---------- Rendering & UI helpers ----------
        function renderForCurrentUser() {
            let baseLeads = allLeads;
            if (currentUser && !currentUser.isAdmin) {
                baseLeads = allLeads.filter(l => l.assign_to === currentUser.displayName);
            }
            renderTable(baseLeads);
            updateMetrics(baseLeads);
            updateAssignedPeopleSection(baseLeads);
        }

        // Implement or reuse your existing renderTable, updateMetrics, updateAssignedPeopleSection, showMessage functions.
        // For completeness include simple implementations here (adapt if your original file had different ones):

        function renderTable(leads) {
            const tbody = document.getElementById('tableBody');
            if (!leads || leads.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14"><div class="empty-state">üìÅ No leads yet.</div></td></tr>';
                return;
            }
            let html = '';
            leads.forEach(l => {
                html += `<tr>
                    <td>${l.lead_id || ''}</td>
                    <td>${escapeHtml(l.full_name || '')}</td>
                    <td>${escapeHtml(l.phone_number || '')}</td>
                    <td>${escapeHtml(l.email || '')}</td>
                    <td>${escapeHtml(l.product || '')}</td>
                    <td>${escapeHtml(l.city || '')}</td>
                    <td>${escapeHtml(l.who_you_are || '')}</td>
                    <td>${escapeHtml(l.reference || '-')}</td>
                    <td>${escapeHtml(l.category || '')}</td>
                    <td>${escapeHtml(l.segment || '')}</td>
                    <td>${escapeHtml(l.assign_to || '')}</td>
                    <td>${escapeHtml(l.status || '')}</td>
                    <td>${escapeHtml(l.campaign_enabled || '')}</td>
                    <td><button class="btn-danger" onclick="deleteLead('${l._id || l.lead_id}')">Delete</button></td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function updateMetrics(leads) {
            const data = leads || allLeads;
            document.getElementById('kpiTotal').textContent = data.length;
            document.getElementById('kpiAssigned').textContent = data.filter(d => d.assign_to && d.assign_to !== '').length;
            document.getElementById('kpiQualified').textContent = data.filter(d => d.status === 'Qualified' || d.status === 'Converted').length;
            document.getElementById('kpiCampaign').textContent = data.filter(d => d.campaign_enabled && d.campaign_enabled.toLowerCase() === 'yes').length;
            document.getElementById('sidebarTotalLeads').textContent = allLeads.length;
        }

        function updateAssignedPeopleSection(leads) {
            const container = document.getElementById('assignedPeopleContainer');
            const data = leads || allLeads;
            const counts = {};
            TEAM_MEMBERS.forEach(m => counts[m] = 0);
            data.forEach(d => {
                if (d.assign_to && counts.hasOwnProperty(d.assign_to)) counts[d.assign_to]++;
            });
            let html = '';
            Object.keys(counts).forEach(name => {
                html += `<div class="assigned-person">
                    <div class="assigned-person-name">${name}</div>
                    <div class="assigned-stats">
                        <div class="stat-item"><span>Total</span><strong>${counts[name]}</strong></div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function showMessage(msg, type = 'success') {
            const box = document.getElementById('messageContainer');
            const div = document.createElement('div');
            div.className = 'message show ' + (type === 'success' ? 'message-success' : 'message-error');
            div.textContent = msg;
            box.appendChild(div);
            setTimeout(() => {
                div.classList.remove('show');
                div.remove();
            }, 5000);
        }

        // Delete lead (works for local or Firebase)
        async function deleteLead(id) {
            if (!confirm('Delete lead?')) return;
            if (USE_FIREBASE && db) {
                try {
                    // if id is Firestore doc id stored in _id use that, else try to find doc where lead_id === id
                    const docById = await db.collection('leads').doc(id).get();
                    if (docById.exists) {
                        await db.collection('leads').doc(id).delete();
                        addDebugLog('üóëÔ∏è Lead removed (by doc id)', 'success');
                        return;
                    }
                    // fallback: find by lead_id field
                    const q = await db.collection('leads').where('lead_id', '==', id).get();
                    q.forEach(async doc => {
                        await db.collection('leads').doc(doc.id).delete();
                    });
                    addDebugLog('üóëÔ∏è Lead removed (by lead_id)', 'success');
                } catch (err) {
                    addDebugLog('Delete error: ' + err.message, 'error');
                }
            } else {
                // local
                allLeads = allLeads.filter(l => (l._id && l._id !== id) && (l.lead_id && l.lead_id !== id) || (!l._id && l.lead_id !== id));
                saveDataToLocal();
                buildPhoneRegistry();
                renderForCurrentUser();
                addDebugLog('üóëÔ∏è Lead removed (local)', 'success');
            }
        }

        // Helper: basic HTML escape
        function escapeHtml(s) {
            if (!s) return '';
            return String(s).replace(/[&<>"']/g, function(m) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
            });
        }

        // Filters (simple wrapper to re-render with current filter values)
        function applyFilters() {
            // reuse existing filter controls (you can keep your original implementation)
            // For simplicity, filter by name/category/segment/assign/status:
            const name = (document.getElementById('searchName').value || '').toLowerCase();
            const category = document.getElementById('filterCategory').value;
            const segment = document.getElementById('filterSegment').value;
            const assignTo = document.getElementById('filterAssignTo').value;
            const status = document.getElementById('filterStatus').value;

            let base = allLeads;
            if (currentUser && !currentUser.isAdmin) base = allLeads.filter(l => l.assign_to === currentUser.displayName);

            const filtered = base.filter(l => {
                if (name && !(l.full_name || '').toLowerCase().includes(name)) return false;
                if (category && l.category !== category) return false;
                if (segment && l.segment !== segment) return false;
                if (assignTo && l.assign_to !== assignTo) return false;
                if (status && l.status !== status) return false;
                return true;
            });
            renderTable(filtered);
            updateMetrics(filtered);
            updateAssignedPeopleSection(filtered);
        }

        function clearFilters() {
            document.getElementById('searchName').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterSegment').value = '';
            document.getElementById('filterAssignTo').value = '';
            document.getElementById('filterStatus').value = '';
            renderForCurrentUser();
        }

        // Settings modal + user management (unchanged)
        function openSettingsModal() {
            if (!currentUser.isAdmin) {
                alert('Only Admin can access Settings');
                return;
            }
            updateUsersList();
            document.getElementById('settingsModal').classList.add('show');
        }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.remove('show'); }
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) closeSettingsModal();
        });
        function updateUsersList() {
            const cont = document.getElementById('usersListContainer');
            let html = '';
            Object.keys(USERS).forEach(u => {
                const user = USERS[u];
                html += `
                    <div class="settings-item">
                        <div style="display:flex;justify-content:space-between;align-items:start;">
                            <div>
                                <div class="settings-item-title">${user.displayName}</div>
                                <div class="settings-item-subtitle">${user.isAdmin ? 'Administrator' : 'Team Member'}</div>
                                <span class="role-badge ${user.isAdmin ? 'admin' : ''}">${user.isAdmin ? 'Admin' : 'Team'}</span>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn-edit" onclick="editUser('${u}')">‚úèÔ∏è Edit</button>
                            <button class="btn-delete" onclick="deleteUser('${u}')" ${u === 'admin' ? 'disabled' : ''}>üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });
            cont.innerHTML = html;
        }
        function editUser(u) {
            const newPass = prompt('Enter new password for ' + u + ':');
            if (newPass) {
                USERS[u].password = newPass;
                updateUsersList();
                addDebugLog('‚úèÔ∏è Password updated', 'success');
            }
        }
        function deleteUser(u) {
            if (u === 'admin') { alert('Cannot delete admin user'); return; }
            if (confirm('Delete user: ' + u + '?')) {
                delete USERS[u];
                updateUsersList();
                addDebugLog('üóëÔ∏è User deleted', 'success');
            }
        }
        function showAddUserForm() {
            const newU = prompt('Enter new username:');
            if (newU && newU.trim()) {
                if (USERS[newU]) { alert('User already exists'); return; }
                const newPass = prompt('Enter password:');
                if (newPass) {
                    const dispName = prompt('Enter display name:');
                    if (dispName) {
                        USERS[newU] = { password: newPass, displayName: dispName, isAdmin: false };
                        updateUsersList();
                        addDebugLog('‚ûï User created', 'success');
                    }
                }
            }
        }
    </script>
</body>
</html>
